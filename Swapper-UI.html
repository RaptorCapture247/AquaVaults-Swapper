<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AquaVaults Swapper</title>
  <script src="https://unpkg.com/@solana/web3.js@1.95.1/lib/index.iife.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #0b0e11; color: #eaeaea; text-align: center; padding: 2rem; }
    input, select, button { margin: 0.5rem; padding: 0.6rem; font-size: 1rem; border-radius: 8px; border: none; }
    button { background: #6366f1; color: white; cursor: pointer; }
    button:hover { background: #4f46e5; }
    button:disabled { background: #4b5563; cursor: not-allowed; }
    .row { margin-top: 1rem; }
    a { color: #818cf8; }
    .info, .fee-controls, .debug, .vault-info, .auto-swap-panel, .rpc-panel, .api-panel { background: #1e293b; padding: 0.75rem; border-radius: 8px; margin: 1rem auto; max-width: 600px; }
    .rpc-panel, .api-panel { background: #1a1f2e; border: 2px solid #6366f1; padding: 1rem; }
    .rpc-panel.configured, .api-panel.configured { border-color: #10b981; background: #1e3a2e; }
    .rpc-status, .api-status { display: inline-block; padding: 0.3rem 0.8rem; border-radius: 16px; font-size: 0.85rem; font-weight: bold; margin: 0.5rem 0; }
    .rpc-status.active, .api-status.active { background: #10b981; color: white; }
    .rpc-status.inactive, .api-status.inactive { background: #64748b; color: white; }
    .rpc-input, .api-input { width: 100%; max-width: 500px; padding: 0.6rem; font-size: 0.9rem; background: #0b0e11; color: #eaeaea; border: 2px solid #4f46e5; border-radius: 6px; font-family: monospace; margin: 0.5rem 0; }
    .rpc-options { display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap; margin: 0.75rem 0; }
    .rpc-option-btn { padding: 0.5rem 1rem; font-size: 0.9rem; background: #334155; color: #eaeaea; }
    .rpc-option-btn:hover { background: #475569; }
    .rpc-option-btn.active { background: #6366f1; color: white; }
    .fee-display { font-size: 1.3rem; font-weight: bold; color: #818cf8; margin: 0.5rem 0; }
    input[type="number"].fee-input { width: 100px; text-align: center; background: #0b0e11; color: #eaeaea; border: 2px solid #4f46e5; }
    input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
    #status { margin-top: 1rem; padding: 1rem; border-radius: 8px; min-height: 20px; }
    .error { color: #ef4444; }
    .success { color: #10b981; }
    .pending { color: #f59e0b; }
    .warning { color: #f59e0b; }
    .controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; max-width: 600px; margin: 1rem auto; }
    .debug { font-size: 0.85rem; text-align: left; font-family: monospace; max-height: 300px; overflow-y: auto; }
    .vault-info { background: #1a1f2e; border: 1px solid #4f46e5; }
    .vault-address { font-family: monospace; font-size: 0.7rem; color: #94a3b8; word-break: break-all; }
    .affiliate-indicator { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 16px; font-size: 0.8rem; font-weight: bold; margin-left: 0.5rem; }
    .affiliate-1 { background: #06fc43; color: white; }
    .affiliate-2 { background: #1004f7; color: white; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .confirming { animation: pulse 2s infinite; }
    .toggle-label { display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 1rem; font-weight: bold; text-align: center; margin: 0 auto; }
    .toggle-option { padding: 0.25rem 0.5rem; border-radius: 8px; transition: all 0.3s ease; text-align: center; min-width: 140px; }
    .toggle-active-1 { background: #06fc43; color: white; }
    .toggle-active-2 { background: #1004f7; color: white; }
    .toggle-inactive { background: transparent; color: #64748b; }
    .auto-swap-panel { background: #1a1f2e; border: 2px solid #6366f1; max-width: 500px; padding: 0.75rem; }
    .auto-controls.disabled { opacity: 0.5; pointer-events: none; }
    .auto-swap-panel.active { border-color: #10b981; background: #1e3a2e; }
    .auto-controls { display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem; }
    .auto-control-row { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; font-size: 0.9rem; }
    .auto-control-row label { flex: 1; text-align: left; font-weight: bold; }
    .auto-control-row input { width: 100px; padding: 0.4rem; font-size: 0.9rem; }
    .progress-display { font-size: 1rem; font-weight: bold; color: #818cf8; margin: 0.5rem 0; }
    .countdown-display { font-size: 0.85rem; color: #94a3b8; margin: 0.25rem 0; min-height: 20px; }
    .auto-button { width: 100%; padding: 0.6rem; font-size: 1rem; font-weight: bold; margin-top: 0.25rem; }
    .auto-button.stop { background: #ef4444; }
    .auto-button.stop:hover { background: #dc2626; }
    .content-disabled { opacity: 0.4; pointer-events: none; }
    .api-key-hint { font-size: 0.75rem; color: #94a3b8; margin: 0.5rem 0; }
    .api-key-masked { font-family: monospace; font-size: 0.75rem; color: #818cf8; }
  </style>
</head>
<body>
  <h1>AquaVaults Swapper</h1>

  <!-- Jupiter API Key Configuration Panel -->
  <div class="api-panel" id="apiPanel">
    <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">üîë Jupiter API Key</h3>
    <div class="api-status inactive" id="apiStatus">Not Configured</div>
    
    <div style="margin: 1rem 0;">
      <p class="api-key-hint">
        <strong>‚ö†Ô∏è Required:</strong> Jupiter migrated to authenticated API.<br>
        Get your <strong>FREE</strong> API key at <a href="https://portal.jup.ag" target="_blank">portal.jup.ag</a> (60 requests/min)
      </p>
      
      <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; font-size: 0.9rem;">
        Enter Your Jupiter API Key:
      </label>
      <input type="password" class="api-input" id="apiKeyInput" placeholder="Enter your Jupiter API key" />
      <p class="api-key-hint">
        Your API key is stored locally and never shared.
      </p>
    </div>
    
    <button id="setApiKeyBtn" onclick="setApiKey()">
      Confirm API Key
    </button>
    
    <button id="changeApiKeyBtn" onclick="changeApiKey()" style="display: none; background: #f59e0b; margin-top: 0.5rem;">
      Change API Key
    </button>
    
    <p id="currentApiKeyDisplay" style="font-size: 0.75rem; color: #94a3b8; margin-top: 0.75rem;"></p>
  </div>

  <!-- RPC Configuration Panel -->
  <div class="rpc-panel" id="rpcPanel">
    <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">üåê RPC Configuration</h3>
    <div class="rpc-status inactive" id="rpcStatus">Not Configured</div>
    
    <div style="margin: 1rem 0;">
      <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; font-size: 0.9rem;">
        Select RPC Provider:
      </label>
      <div class="rpc-options">
        <button class="rpc-option-btn" onclick="selectRpcOption('default')">Default RPC</button>
        <button class="rpc-option-btn" onclick="selectRpcOption('custom')">Custom RPC</button>
      </div>
    </div>
    
    <div id="customRpcInput" style="display: none; margin: 1rem 0;">
      <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; font-size: 0.9rem;">
        Enter Custom RPC URL:
      </label>
      <input type="text" class="rpc-input" id="rpcUrl" placeholder="https://your-rpc-endpoint.com" />
      <p style="font-size: 0.75rem; color: #94a3b8; margin: 0.5rem 0;">
        Examples: Helius, QuickNode, Alchemy, or your own RPC
      </p>
    </div>
    
    <button id="setRpcBtn" onclick="setRpcEndpoint()" style="margin-top: 0.5rem;">
      Confirm RPC
    </button>
    
    <button id="changeRpcBtn" onclick="changeRpc()" style="display: none; background: #f59e0b; margin-top: 0.5rem;">
      Change RPC
    </button>
    
    <p id="currentRpcDisplay" style="font-size: 0.75rem; color: #94a3b8; margin-top: 0.75rem; word-break: break-all; font-family: monospace;"></p>
  </div>

  <div id="mainContent" class="content-disabled">
    <div class="info">
      <p><strong>Choose Your Affiliate</strong></p>
      <p style="font-size: 0.8rem; word-break: break-all;"> </p>
      <div style="margin-top: 1rem;">
        <label class="toggle-label">
          <span id="affiliate1Label" class="toggle-option">
          Pond0x<br><small>(Swap Rewards &</small><br><small>Mining Boost)</small></span>
          <input type="checkbox" id="affiliateToggle" />
          <span id="affiliate2Label" class="toggle-option">
          AquaVaults<br><small>(Support Development)</small></span>
        </label>
        <p style="font-size: 0.75rem; color: #64748b; margin-top: 0.5rem;">Check To Use AquaVaults</p>
      </div>
    </div>

    <div class="vault-info">
      <p><strong>ü¶à Active Token Vault</strong> <span id="affiliateIndicator" class="affiliate-indicator affiliate-1">Pond0x</span></p>
      <p id="activeVault" class="vault-address">Select a token to see vault</p>
    </div>

    <div class="controls-grid">
      <div class="fee-controls">
        <p><strong>üí∞ Platform Fee</strong></p>
        <div class="fee-display"><span id="feePercent">1.00</span>%</div>
        <input type="number" id="feeInput" class="fee-input" min="0" max="1000" value="100" step="5" />
        <p style="font-size: 0.8rem; color: #94a3b8;">bps (100 = 1.00%)</p>
      </div>
      <div class="fee-controls">
        <p><strong>üìä Slippage</strong></p>
        <div class="fee-display"><span id="slippagePercent">1.00</span>%</div>
        <input type="number" id="slippageInput" class="fee-input" min="0" max="5000" value="100" step="50" />
        <p style="font-size: 0.8rem; color: #94a3b8;">bps (100 = 1.00%)</p>
      </div>
    </div>

    <div class="row">
      <label>From:</label>
      <select id="inputMint">
        <option value="So11111111111111111111111111111111111111112">SOL</option>
        <option value="EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v">USDC</option>
        <option value="Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB">USDT</option>
        <option value="3JgFwoYV74f6LwWjQWnr3YDPFnmBdwQfNyubv99jqUoq">wPOND</option>
        <option value="he1iusmfkpAdwvxLNGV8Y1iSbj4rUy6yMhEA3fotn9A">hSOL</option>
        <option value="mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So">mSOL</option>
        <option value="B5WTLaRwaUQpKk7ir1wniNB6m5o8GgMrimhKMYan2R6B">PepeOnSOL</option>
      </select>
    </div>

    <div class="row">
      <label>To:</label>
      <select id="outputMint">
        <option value="EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v">USDC</option>
        <option value="Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB">USDT</option>
        <option value="So11111111111111111111111111111111111111112">SOL</option>
        <option value="3JgFwoYV74f6LwWjQWnr3YDPFnmBdwQfNyubv99jqUoq">wPOND</option>
        <option value="he1iusmfkpAdwvxLNGV8Y1iSbj4rUy6yMhEA3fotn9A">hSOL</option>
        <option value="mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So">mSOL</option>
        <option value="B5WTLaRwaUQpKk7ir1wniNB6m5o8GgMrimhKMYan2R6B">PepeOnSOL</option>
      </select>
    </div>

    <div class="row">
      <label>Amount:</label>
      <input id="amount" type="text" placeholder="Enter amount" pattern="[0-9]*\.?[0-9]*" inputmode="decimal" />
    </div>

    <p id="balance">Balance: ‚Äî</p>
    <p id="estimate">Estimated output: ‚Äî</p>

    <button id="connect">Connect Wallet</button>
    <button id="swap" disabled>Swap</button>

    <p id="status"></p>
    <div id="debug" class="debug" style="display: none;"></div>

    <!-- Auto Swap Control Panel -->
    <div class="auto-swap-panel" id="autoPanel">
      <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">ü§ñ Auto Swap Control</h3>
      
      <div class="auto-controls" id="autoControls">
        <div class="auto-control-row">
          <label for="swapCount">Number of Swaps:</label>
          <input type="number" id="swapCount" min="1" max="1000" value="10" />
        </div>
        
        <div class="auto-control-row">
          <label for="waitTime">Wait After Swap (seconds):</label>
          <input type="number" id="waitTime" min="0" max="300" value="5" step="1" />
        </div>
        
        <div style="margin: 0.5rem 0; padding: 0.5rem; background: #0f172a; border-radius: 6px;">
          <label style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-weight: bold; cursor: pointer; margin-bottom: 0.5rem; font-size: 0.9rem;">
            <input type="checkbox" id="randomAmountToggle" />
            <span>üé≤ Use Random Amount</span>
          </label>
          
          <div id="randomAmountControls" style="opacity: 0.5; pointer-events: none;">
            <div class="auto-control-row" style="margin-bottom: 0.25rem;">
              <label for="minAmount" style="font-size: 0.85rem;">Min Amount:</label>
              <input type="number" id="minAmount" min="0" step="0.01" value="0.01" style="width: 90px; padding: 0.4rem; font-size: 0.85rem; background: #0b0e11; color: #eaeaea; border: 2px solid #4f46e5; border-radius: 6px;" />
            </div>
            
            <div class="auto-control-row">
              <label for="maxAmount" style="font-size: 0.85rem;">Max Amount:</label>
              <input type="number" id="maxAmount" min="0" step="0.01" value="1.0" style="width: 90px; padding: 0.4rem; font-size: 0.85rem; background: #0b0e11; color: #eaeaea; border: 2px solid #4f46e5; border-radius: 6px;" />
            </div>
            
            <p style="font-size: 0.7rem; color: #94a3b8; margin: 0.5rem 0 0 0; text-align: center;">Random amount per swap (min to max)</p>
          </div>
        </div>
        
        <div class="progress-display" id="autoProgress">Ready</div>
        <div class="countdown-display" id="autoCountdown"></div>
        
        <button class="auto-button" id="autoStart" disabled>Start Auto Swap</button>
        <button class="auto-button stop" id="autoStop" style="display: none;">Stop Auto Swap</button>
      </div>
    </div>

    <!-- Auto Swap Enable Toggle -->
    <div style="margin: 1rem auto; max-width: 500px;">
      <label style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-weight: bold; cursor: pointer; font-size: 1rem;">
        <input type="checkbox" id="autoToggle" />
        <span>ü§ñ Enable Auto Swap Control</span>
      </label>
    </div>
  </div>

  <script>
    // Pond0x Token Vaults (Original)
    const TOKEN_VAULTS_AFFILIATE_1 = {
      "So11111111111111111111111111111111111111112": "9hCLuXrQrHCU9i7y648Nh7uuWKHUsKDiZ5zyBHdZPWtG", // SOL
      "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v": "6NqvoPpSYCPEtLEukQaSNs7mS3yK6k285saH9o3vgC96", // USDC
      "Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB": "5LmFGjbae5iWejFVT8UiRLggh1me22nTetmere8SjwKy", // USDT
      "3JgFwoYV74f6LwWjQWnr3YDPFnmBdwQfNyubv99jqUoq": "GKHmDYWPE8Bf74xDntnpx4hi4H7pRp3HK5QYvPyXGEiU", // wPOND
      "he1iusmfkpAdwvxLNGV8Y1iSbj4rUy6yMhEA3fotn9A": "4jkVjzXtrCuxQus3neMtLfNL4wZhsPmm9fKGXoLMXqsG", // hSOL
      "B5WTLaRwaUQpKk7ir1wniNB6m5o8GgMrimhKMYan2R6B": "3qGSU2RySrjvQ2iGMts2HZ4ssGVSrBUSGL4jN7LHGhgo", // PepeOnSOL
    };

    // AquaVaults Token Vaults (New)
    const TOKEN_VAULTS_AFFILIATE_2 = {
      "So11111111111111111111111111111111111111112": "2qcR7nCVRmpxHCYTdQ6G1DjNcDzgEq9eQ1ZrxcmjeVy9", // SOL
      "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v": "4en3gmtiPtmiHCi5mwT1TrATj4jNe7woJPZLQaWv6Ezu", // USDC
      "Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB": "5wV1qSp8n9z5DEGHV6JJoEoxdYeBrnVCtP9LbD4Vwx7D", // USDT
      "3JgFwoYV74f6LwWjQWnr3YDPFnmBdwQfNyubv99jqUoq": "E4s4KzRBvYQxpFR1L7z7cLDtT814i7bqWFSGgqCDBCn9", // wPOND
      "he1iusmfkpAdwvxLNGV8Y1iSbj4rUy6yMhEA3fotn9A": "54GcC3SjZzavvVJ5ipFfCvQHNnpPRsJLXUdfxNmeJHHm", // hSOL
      "mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So": "49URcyxPiaKRgoEAWfDtJHGWcZus3SVkF39b9Szf3XqC", // mSOL
      "B5WTLaRwaUQpKk7ir1wniNB6m5o8GgMrimhKMYan2R6B": "Ff7tzrabm8sxHbL4cTmBDby2EQvvtab6NTh56R69u6KS", // PepeOnSOL
    };

    // Token names for display
    const TOKEN_NAMES = {
      "So11111111111111111111111111111111111111112": "SOL",
      "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v": "USDC",
      "Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB": "USDT",
      "3JgFwoYV74f6LwWjQWnr3YDPFnmBdwQfNyubv99jqUoq": "wPOND",
      "he1iusmfkpAdwvxLNGV8Y1iSbj4rUy6yMhEA3fotn9A": "hSOL",
      "mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So": "mSOL",
      "B5WTLaRwaUQpKk7ir1wniNB6m5o8GgMrimhKMYan2R6B": "PepeOnSOL"
    };

    const REFERRAL_PROGRAM_ID = "JUP6LkbZbjS1jKKwapdHNy74zcZ3tLUZoi5QNyVTaV4";
    const DEFAULT_RPC = "https://api.mainnet-beta.solana.com";
    const JUPITER_API_BASE = "https://api.jup.ag"; // NEW: Updated from lite-api.jup.ag
    
    let connection = null;
    let currentRpcUrl = null;
    let rpcConfigured = false;
    let selectedRpcOption = null;
    let jupiterApiKey = null; // NEW: Store API key
    let apiKeyConfigured = false; // NEW: Track API key status

    let walletPublicKey = null, isWalletConnected = false;

    const TOKEN_DECIMALS = {
      "So11111111111111111111111111111111111111112": 9,  // SOL
      "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v": 6,  // USDC
      "Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB": 6,  // USDT
      "3JgFwoYV74f6LwWjQWnr3YDPFnmBdwQfNyubv99jqUoq": 3,  // wPOND
      "he1iusmfkpAdwvxLNGV8Y1iSbj4rUy6yMhEA3fotn9A": 9,   // hSOL
      "mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So": 9,    // mSOL
      "B5WTLaRwaUQpKk7ir1wniNB6m5o8GgMrimhKMYan2R6B": 6,    // PepeOnSOL
    };

    // Cache for dynamically fetched decimals
    const decimalsCache = {};

    // Fetch token decimals from blockchain
    async function getTokenDecimals(mintAddress) {
      if (TOKEN_DECIMALS[mintAddress]) return TOKEN_DECIMALS[mintAddress];
      if (decimalsCache[mintAddress]) return decimalsCache[mintAddress];
      if (!connection) return 6;
      try {
        const mintPubkey = new solanaWeb3.PublicKey(mintAddress);
        const mintInfo = await connection.getParsedAccountInfo(mintPubkey);
        if (mintInfo.value && mintInfo.value.data.parsed) {
          const decimals = mintInfo.value.data.parsed.info.decimals;
          decimalsCache[mintAddress] = decimals;
          debugLog(`‚úÖ ${TOKEN_NAMES[mintAddress]}: ${decimals} decimals`);
          return decimals;
        }
      } catch (err) {
        debugLog(`‚ùå Error fetching decimals: ${err.message}`);
      }
      return 6;
    }

    let platformFeeBps = 100;
    let slippageBps = 100;
    let useAffiliate2 = false;

    // Auto swap state
    let autoSwapEnabled = false;
    let autoSwapRunning = false;
    let autoSwapCancelled = false;
    let countdownInterval = null;
    let useRandomAmount = false;

    // Initialize from localStorage on page load
    window.addEventListener('DOMContentLoaded', () => {
      const savedApiKey = localStorage.getItem('jupiterApiKey');
      const savedRpcOption = localStorage.getItem('rpcOption');
      const savedCustomRpc = localStorage.getItem('customRpcUrl');
      const savedAffiliate = localStorage.getItem('useAffiliate2');
      
      if (savedAffiliate) {
        useAffiliate2 = savedAffiliate === 'true';
        document.getElementById("affiliateToggle").checked = useAffiliate2;
      }
      
      // Load API key first
      if (savedApiKey) {
        jupiterApiKey = savedApiKey;
        apiKeyConfigured = true;
        updateApiKeyDisplay();
      }
      
      // Then load RPC if API key is configured
      if (apiKeyConfigured && savedRpcOption) {
        if (savedRpcOption === 'custom' && savedCustomRpc) {
          selectRpcOption('custom');
          document.getElementById('rpcUrl').value = savedCustomRpc;
          setRpcEndpoint();
        } else if (savedRpcOption === 'default') {
          selectRpcOption('default');
          setRpcEndpoint();
        }
      }
      
      updateAffiliateDisplay();
    });

    // NEW: API Key Configuration Functions
    function setApiKey() {
      const apiKey = document.getElementById('apiKeyInput').value.trim();
      
      if (!apiKey) {
        alert('Please enter your Jupiter API key');
        return;
      }
      
      if (apiKey.length < 20) {
        alert('API key seems too short. Please check and try again.');
        return;
      }
      
      // Store API key
      jupiterApiKey = apiKey;
      apiKeyConfigured = true;
      localStorage.setItem('jupiterApiKey', apiKey);
      
      // Update UI
      updateApiKeyDisplay();
      
      debugLog('üîë Jupiter API key configured');
    }

    function updateApiKeyDisplay() {
      if (apiKeyConfigured) {
        const maskedKey = jupiterApiKey.substring(0, 8) + '...' + jupiterApiKey.substring(jupiterApiKey.length - 4);
        
        document.getElementById('apiStatus').textContent = '‚úÖ Configured';
        document.getElementById('apiStatus').className = 'api-status active';
        document.getElementById('apiPanel').classList.add('configured');
        document.getElementById('setApiKeyBtn').style.display = 'none';
        document.getElementById('changeApiKeyBtn').style.display = 'inline-block';
        document.getElementById('currentApiKeyDisplay').innerHTML = `<span class="api-key-masked">Key: ${maskedKey}</span>`;
        document.getElementById('apiKeyInput').type = 'password';
        document.getElementById('apiKeyInput').value = '';
      }
    }

    function changeApiKey() {
      // Reset API key configuration
      apiKeyConfigured = false;
      jupiterApiKey = null;
      
      // Reset UI
      document.getElementById('apiStatus').textContent = 'Not Configured';
      document.getElementById('apiStatus').className = 'api-status inactive';
      document.getElementById('apiPanel').classList.remove('configured');
      document.getElementById('setApiKeyBtn').style.display = 'inline-block';
      document.getElementById('changeApiKeyBtn').style.display = 'none';
      document.getElementById('currentApiKeyDisplay').textContent = '';
      document.getElementById('apiKeyInput').value = '';
      document.getElementById('apiKeyInput').type = 'password';
      
      // Reset RPC if configured (since API key is required)
      if (rpcConfigured) {
        changeRpc();
      }
      
      debugLog('üîÑ API key configuration reset');
    }

    // RPC Configuration Functions
    function selectRpcOption(option) {
      selectedRpcOption = option;
      
      // Update button states
      document.querySelectorAll('.rpc-option-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      if (option === 'default') {
        document.querySelectorAll('.rpc-option-btn')[0].classList.add('active');
        document.getElementById('customRpcInput').style.display = 'none';
      } else if (option === 'custom') {
        document.querySelectorAll('.rpc-option-btn')[1].classList.add('active');
        document.getElementById('customRpcInput').style.display = 'block';
      }
    }

    function setRpcEndpoint() {
      // Check API key first
      if (!apiKeyConfigured) {
        alert('‚ö†Ô∏è Please configure Jupiter API key first!');
        return;
      }
      
      let rpcUrl;
      
      if (selectedRpcOption === 'default') {
        rpcUrl = DEFAULT_RPC;
      } else if (selectedRpcOption === 'custom') {
        rpcUrl = document.getElementById('rpcUrl').value.trim();
        if (!rpcUrl) {
          alert('Please enter a custom RPC URL');
          return;
        }
        if (!rpcUrl.startsWith('http://') && !rpcUrl.startsWith('https://')) {
          alert('RPC URL must start with http:// or https://');
          return;
        }
      } else {
        alert('Please select an RPC option');
        return;
      }
      
      // Initialize connection
      try {
        connection = new solanaWeb3.Connection(rpcUrl, 'confirmed');
        currentRpcUrl = rpcUrl;
        rpcConfigured = true;
        
        // Save to localStorage
        localStorage.setItem('rpcOption', selectedRpcOption);
        if (selectedRpcOption === 'custom') {
          localStorage.setItem('customRpcUrl', rpcUrl);
        }
        
        // Update UI
        document.getElementById('rpcStatus').textContent = '‚úÖ Configured';
        document.getElementById('rpcStatus').className = 'rpc-status active';
        document.getElementById('rpcPanel').classList.add('configured');
        document.getElementById('setRpcBtn').style.display = 'none';
        document.getElementById('changeRpcBtn').style.display = 'inline-block';
        
        // Show current RPC (truncated if too long)
        const displayRpc = rpcUrl.length > 60 ? rpcUrl.substring(0, 57) + '...' : rpcUrl;
        document.getElementById('currentRpcDisplay').textContent = `Current RPC: ${displayRpc}`;
        
        // Enable main content
        document.getElementById('mainContent').classList.remove('content-disabled');
        
        debugLog(`üåê RPC configured: ${selectedRpcOption === 'default' ? 'Default' : 'Custom'}`);
        
      } catch (err) {
        alert('Error initializing RPC connection. Please check your URL and try again.');
        console.error(err);
      }
    }

    function changeRpc() {
      // Reset configuration
      rpcConfigured = false;
      connection = null;
      currentRpcUrl = null;
      selectedRpcOption = null;
      
      // Reset UI
      document.getElementById('rpcStatus').textContent = 'Not Configured';
      document.getElementById('rpcStatus').className = 'rpc-status inactive';
      document.getElementById('rpcPanel').classList.remove('configured');
      document.getElementById('setRpcBtn').style.display = 'inline-block';
      document.getElementById('changeRpcBtn').style.display = 'none';
      document.getElementById('currentRpcDisplay').textContent = '';
      document.getElementById('customRpcInput').style.display = 'none';
      document.getElementById('rpcUrl').value = '';
      
      document.querySelectorAll('.rpc-option-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Disable main content
      document.getElementById('mainContent').classList.add('content-disabled');
      
      // Disconnect wallet if connected
      if (isWalletConnected) {
        disconnectWallet();
      }
      
      debugLog('üîÑ RPC configuration reset');
    }

    // Initialize toggle state
    updateAffiliateDisplay();

    const updateFeeDisplay = bps => document.getElementById("feePercent").textContent = (bps / 100).toFixed(2);
    const updateSlippageDisplay = bps => document.getElementById("slippagePercent").textContent = (bps / 100).toFixed(2);
    updateFeeDisplay(platformFeeBps); updateSlippageDisplay(slippageBps);

    // Update affiliate display based on toggle state
    function updateAffiliateDisplay() {
      const isAffiliate2 = document.getElementById("affiliateToggle").checked;
      const indicator = document.getElementById("affiliateIndicator");
      const label1 = document.getElementById("affiliate1Label");
      const label2 = document.getElementById("affiliate2Label");
      
      if (isAffiliate2) {
        indicator.textContent = "AquaVaults";
        indicator.className = "affiliate-indicator affiliate-2";
        label1.className = "toggle-option toggle-inactive";
        label2.className = "toggle-option toggle-active-2";
      } else {
        indicator.textContent = "Pond0x";
        indicator.className = "affiliate-indicator affiliate-1";
        label1.className = "toggle-option toggle-active-1";
        label2.className = "toggle-option toggle-inactive";
      }
      
      updateActiveVault();
    }

    // Get current active token vaults based on toggle
    function getCurrentVaults() {
      return document.getElementById("affiliateToggle").checked ? 
        TOKEN_VAULTS_AFFILIATE_2 : TOKEN_VAULTS_AFFILIATE_1;
    }

    // Update active vault display
    function updateActiveVault() {
      const inputMint = document.getElementById("inputMint").value;
      const vaults = getCurrentVaults();
      const vault = vaults[inputMint];
      const tokenName = TOKEN_NAMES[inputMint];
      const affiliateName = document.getElementById("affiliateToggle").checked ? "AquaVaults" : "Pond0x";
      
      if (vault) {
        document.getElementById("activeVault").innerHTML = `${tokenName} Vault (${affiliateName}): ${vault}`;
      } else {
        document.getElementById("activeVault").innerHTML = `No vault configured for selected token. Please change affiliate.`;
      }
    }

    // Auto swap toggle handler
    document.getElementById("autoToggle").onchange = e => {
      autoSwapEnabled = e.target.checked;
      const controls = document.getElementById("autoControls");
      const startBtn = document.getElementById("autoStart");
      
      if (autoSwapEnabled) {
        controls.classList.remove("disabled");
        if (isWalletConnected) {
          startBtn.disabled = false;
        }
        debugLog("ü§ñ Auto swap control enabled");
      } else {
        controls.classList.add("disabled");
        startBtn.disabled = true;
        debugLog("ü§ñ Auto swap control disabled");
      }
    };

    // Initialize auto controls as disabled
    document.getElementById("autoControls").classList.add("disabled");

    // Random amount toggle handler
    document.getElementById("randomAmountToggle").onchange = e => {
      useRandomAmount = e.target.checked;
      const controls = document.getElementById("randomAmountControls");
      if (useRandomAmount) {
        controls.style.opacity = "1";
        controls.style.pointerEvents = "auto";
        debugLog("üé≤ Random amount enabled");
      } else {
        controls.style.opacity = "0.5";
        controls.style.pointerEvents = "none";
        debugLog("üé≤ Random amount disabled");
      }
    };

    // Event handlers
    document.getElementById("affiliateToggle").onchange = e => {
      useAffiliate2 = e.target.checked;
      localStorage.setItem("useAffiliate2", useAffiliate2);
      updateAffiliateDisplay();
      debugLog(`Switched to ${useAffiliate2 ? 'AquaVaults' : 'Pond0x'} vaults`);
    };

    document.getElementById("feeInput").oninput = e => {
      platformFeeBps = parseInt(e.target.value) || 100;
      updateFeeDisplay(platformFeeBps); getEstimate();
    };

    document.getElementById("slippageInput").oninput = e => {
      slippageBps = parseInt(e.target.value) || 100;
      updateSlippageDisplay(slippageBps); getEstimate();
    };

    const debugLog = msg => {
      const d = document.getElementById("debug");
      d.style.display = "block"; const t = new Date().toLocaleTimeString();
      d.innerHTML += `<div>[${t}] ${msg}</div>`; console.log(`[${t}]`, msg);
    };

    async function connectWallet() {
      if (!apiKeyConfigured) {
        alert("‚ö†Ô∏è Please configure Jupiter API key first!");
        return;
      }
      
      if (!rpcConfigured) {
        alert("‚ö†Ô∏è Please configure RPC endpoint first!");
        return;
      }

      if (!window.solana) return alert("‚ö†Ô∏è No wallet detected!");
      if (isWalletConnected) return disconnectWallet();

      try {
        const resp = await window.solana.connect();
        walletPublicKey = resp.publicKey.toBase58();
        isWalletConnected = true;
        document.getElementById("status").innerHTML = `‚úÖ Connected: <b>${walletPublicKey.slice(0, 4)}...${walletPublicKey.slice(-4)}</b>`;
        document.getElementById("connect").innerText = "Disconnect";
        document.getElementById("swap").disabled = false;
        
        // Enable auto swap start button if auto toggle is enabled
        if (autoSwapEnabled) {
          document.getElementById("autoStart").disabled = false;
        }
        
        await updateBalance();
      } catch (err) {
        document.getElementById("status").innerHTML = `<span class="error">‚ùå ${err.message}</span>`;
      }
    }

    async function disconnectWallet() {
      if (window.solana?.isConnected) await window.solana.disconnect();
      walletPublicKey = null; isWalletConnected = false;
      document.getElementById("status").innerText = "Disconnected";
      document.getElementById("connect").innerText = "Connect Wallet";
      document.getElementById("swap").disabled = true;
      document.getElementById("autoStart").disabled = true;
    }

    async function updateBalance() {
      if (!walletPublicKey || !connection) return;
      const mint = document.getElementById("inputMint").value;
      let bal = 0;
      try {
        if (mint === "So11111111111111111111111111111111111111112")
          bal = (await connection.getBalance(new solanaWeb3.PublicKey(walletPublicKey))) / 1e9;
        else {
          const accs = await connection.getParsedTokenAccountsByOwner(new solanaWeb3.PublicKey(walletPublicKey), { mint: new solanaWeb3.PublicKey(mint) });
          if (accs.value.length > 0) bal = accs.value[0].account.data.parsed.info.tokenAmount.uiAmount;
        }
        document.getElementById("balance").innerText = `Balance: ${bal.toFixed(6)}`;
      } catch { document.getElementById("balance").innerText = "Balance: Error"; }
    }

    async function getEstimate() {
      if (!apiKeyConfigured) return;
      
      const inputMint = document.getElementById("inputMint").value;
      const outputMint = document.getElementById("outputMint").value;
      const uiAmount = parseFloat(document.getElementById("amount").value);
      if (isNaN(uiAmount) || !uiAmount || uiAmount <= 0) return document.getElementById("estimate").innerText = "Estimated output: ‚Äî";
      const decimals = await getTokenDecimals(inputMint);
      const amount = Math.floor(uiAmount * 10 ** decimals);
      
      // Validate amount is a valid number
      if (isNaN(amount) || amount <= 0) return document.getElementById("estimate").innerText = "Estimated output: ‚Äî";

      // NEW: Updated to use api.jup.ag with API key header
      let url = `${JUPITER_API_BASE}/swap/v1/quote?inputMint=${inputMint}&outputMint=${outputMint}&amount=${amount}&slippageBps=${slippageBps}&platformFeeBps=${platformFeeBps}`;
      try {
        const quote = await fetch(url, {
          headers: {
            'x-api-key': jupiterApiKey
          }
        }).then(r => r.json());
        const outDecimals = await getTokenDecimals(outputMint);
        document.getElementById("estimate").innerText = `Estimated output: ‚âà ${(quote.outAmount / 10 ** outDecimals).toFixed(6)}`;
      } catch { document.getElementById("estimate").innerText = "Estimated output: Error"; }
    }

    async function swap(overrideAmount = null) {
      if (!apiKeyConfigured) {
        alert("‚ö†Ô∏è Jupiter API key not configured!");
        return;
      }
      
      if (!rpcConfigured || !connection) {
        alert("‚ö†Ô∏è RPC not configured!");
        return;
      }
      
      if (!walletPublicKey) return alert("Connect wallet first!");
      const inputMint = document.getElementById("inputMint").value;
      const outputMint = document.getElementById("outputMint").value;
      
      // Check if overrideAmount is actually a number (not an event object)
      const useOverride = typeof overrideAmount === 'number' && !isNaN(overrideAmount);
      const uiAmount = useOverride ? overrideAmount : parseFloat(document.getElementById("amount").value);
      
      // Debug logging
      debugLog(`Amount input value: "${document.getElementById("amount").value}"`);
      debugLog(`Parsed uiAmount: ${uiAmount}`);
      debugLog(`Using override: ${useOverride}`);
      
      // Better validation for NaN
      if (isNaN(uiAmount) || !uiAmount || uiAmount <= 0) {
        alert("Please enter a valid amount");
        debugLog(`‚ùå Validation failed - uiAmount is invalid: ${uiAmount}`);
        return;
      }

      const decimals = await getTokenDecimals(inputMint);
      const amount = Math.floor(uiAmount * 10 ** decimals);
      
      debugLog(`Calculated amount in smallest units: ${amount}`);
      
      // Double-check amount is valid number
      if (isNaN(amount) || amount <= 0) {
        alert("Invalid amount calculated. Please check your input.");
        debugLog(`‚ùå Amount calculation failed - amount: ${amount}`);
        return;
      }

      // Get the appropriate vault for the selected input token and affiliate
      const vaults = getCurrentVaults();
      const referralVault = vaults[inputMint];
      const tokenName = TOKEN_NAMES[inputMint];
      const affiliateName = document.getElementById("affiliateToggle").checked ? "AquaVaults" : "Pond0x";
      
      if (!referralVault) {
        alert(`‚ö†Ô∏è The selected affiliate (${affiliateName}) does not have a vault for ${tokenName}. Please choose a different affiliate or token.`);
        document.getElementById("swap").disabled = true;
        return;
      }

      debugLog(`Input Token: ${tokenName} (${inputMint})`);
      debugLog(`Using ${affiliateName} Vault: ${referralVault}`);
      debugLog(`Fee: ${platformFeeBps}bps, Slippage: ${slippageBps}`);

      // Disable swap button during transaction
      document.getElementById("swap").disabled = true;
      document.getElementById("status").innerHTML = `<span class="pending">‚è≥Preparing transaction...</span>`;

      // NEW: Updated to use api.jup.ag with API key header
      let quoteUrl = `${JUPITER_API_BASE}/swap/v1/quote?inputMint=${inputMint}&outputMint=${outputMint}&amount=${amount}&slippageBps=${slippageBps}&platformFeeBps=${platformFeeBps}`;
      
      try {
        const quote = await fetch(quoteUrl, {
          headers: {
            'x-api-key': jupiterApiKey
          }
        }).then(r => r.json());

        const swapBody = {
          userPublicKey: walletPublicKey,
          wrapAndUnwrapSol: true,
          quoteResponse: quote,
          swapMode: "ExactIn",
          dynamicComputeUnitLimit: true,
          prioritizationFeeLamports: "auto",
          platformFeeBps: platformFeeBps,
          feeAccount: referralVault
        };

        debugLog(`Referral vault added for ${tokenName} (${affiliateName}): ${referralVault} ‚úÖ`);
        debugLog("Building and sending transaction...");
        document.getElementById("status").innerHTML = `<span class="pending">‚è≥ Building transaction...</span>`;

        // NEW: Updated to use api.jup.ag with API key header
        const res = await fetch(`${JUPITER_API_BASE}/swap/v1/swap`, {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "x-api-key": jupiterApiKey
          },
          body: JSON.stringify(swapBody),
        });

        if (!res.ok) {
          const errText = await res.text();
          debugLog(`‚ùå Jupiter API Error (${res.status}): ${errText}`);
          document.getElementById("status").innerHTML = `<span class="error">‚ùå Jupiter API Error (${res.status})</span>`;
          document.getElementById("swap").disabled = false;
          return;
        }

        const swapRes = await res.json();
        if (!swapRes.swapTransaction) {
          debugLog("‚ùå No swapTransaction returned from API");
          document.getElementById("status").innerHTML = `<span class="error">‚ùå No swapTransaction returned</span>`;
          document.getElementById("swap").disabled = false;
          return;
        }

        const tx = solanaWeb3.VersionedTransaction.deserialize(
          Uint8Array.from(atob(swapRes.swapTransaction), c => c.charCodeAt(0))
        );

        document.getElementById("status").innerHTML = `<span class="pending">‚è≥ Please approve transaction in wallet...</span>`;
        const signedTx = await window.solana.signTransaction(tx);

        document.getElementById("status").innerHTML = `<span class="pending">‚è≥ Sending transaction...</span>`;
        const sig = await connection.sendRawTransaction(signedTx.serialize());
        
        // Show confirming status with animation
        document.getElementById("status").innerHTML = `<span class="pending confirming">‚è≥ Confirming transaction... ${sig.slice(0, 8)}...</span>`;
        debugLog(`Transaction sent with ${affiliateName}: ${sig}`);
        
        // Wait for confirmation
        await connection.confirmTransaction(sig, "confirmed");
        
        // Only show the View TX link after confirmation
        document.getElementById("status").innerHTML = `<span class="success">‚úÖ Transaction Confirmed (${affiliateName})!</span> <a href="https://solscan.io/tx/${sig}" target="_blank">View TX ‚Üí</a>`;
        debugLog(`‚úÖ Transaction confirmed for ${affiliateName}: ${sig}`);

        // Update balance after successful swap
        await updateBalance();
        
      } catch (err) {
        debugLog(`‚ùå Transaction error: ${err.message}`);
        document.getElementById("status").innerHTML = `<span class="error">‚ùå ${err.message}</span>`;
        throw err; // Re-throw for auto swap error handling
      } finally {
        // Re-enable swap button
        document.getElementById("swap").disabled = false;
      }
    }

    // Auto swap functions
    async function startAutoSwap() {
      const totalSwaps = parseInt(document.getElementById("swapCount").value);
      const waitTime = parseInt(document.getElementById("waitTime").value);
      
      if (!totalSwaps || totalSwaps < 1) {
        alert("Please enter a valid number of swaps");
        return;
      }
      
      if (!isWalletConnected) {
        alert("Please connect wallet first");
        return;
      }
      
      if (!rpcConfigured) {
        alert("Please configure RPC first");
        return;
      }
      
      if (!apiKeyConfigured) {
        alert("Please configure Jupiter API key first");
        return;
      }
      
      // Validate random amount settings if enabled
      if (useRandomAmount) {
        const minAmount = parseFloat(document.getElementById("minAmount").value);
        const maxAmount = parseFloat(document.getElementById("maxAmount").value);
        
        if (isNaN(minAmount) || isNaN(maxAmount) || minAmount <= 0 || maxAmount <= 0) {
          alert("Please enter valid min and max amounts");
          return;
        }
        
        if (minAmount >= maxAmount) {
          alert("Min amount must be less than max amount");
          return;
        }
      }

      autoSwapRunning = true;
      autoSwapCancelled = false;
      
      // Update UI
      document.getElementById("autoStart").style.display = "none";
      document.getElementById("autoStop").style.display = "block";
      document.getElementById("autoPanel").classList.add("active");
      document.getElementById("swap").disabled = true;
      document.getElementById("swapCount").disabled = true;
      document.getElementById("waitTime").disabled = true;
      document.getElementById("randomAmountToggle").disabled = true;
      document.getElementById("minAmount").disabled = true;
      document.getElementById("maxAmount").disabled = true;
      
      debugLog(`ü§ñ Starting auto swap: ${totalSwaps} swaps with ${waitTime}s wait`);
      
      if (useRandomAmount) {
        const minAmount = parseFloat(document.getElementById("minAmount").value);
        const maxAmount = parseFloat(document.getElementById("maxAmount").value);
        debugLog(`üé≤ Random amount enabled: ${minAmount} - ${maxAmount}`);
      }
      
      let completedSwaps = 0;
      let failedSwaps = 0;
      
      for (let i = 1; i <= totalSwaps; i++) {
        if (autoSwapCancelled) {
          debugLog("üõë Auto swap cancelled by user");
          break;
        }
        
        // Generate random amount if enabled
        let swapAmount = null;
        if (useRandomAmount) {
          const minAmount = parseFloat(document.getElementById("minAmount").value);
          const maxAmount = parseFloat(document.getElementById("maxAmount").value);
          swapAmount = (Math.random() * (maxAmount - minAmount) + minAmount).toFixed(4);
          debugLog(`üé≤ Random amount for swap ${i}: ${swapAmount}`);
        }
        
        // Update progress
        document.getElementById("autoProgress").textContent = `Swap ${i} of ${totalSwaps}${swapAmount ? ' (' + swapAmount + ')' : ''}`;
        debugLog(`ü§ñ Executing swap ${i}/${totalSwaps}${swapAmount ? ' with amount ' + swapAmount : ''}`);
        
        try {
          await swap(swapAmount ? parseFloat(swapAmount) : null);
          completedSwaps++;
          debugLog(`‚úÖ Auto swap ${i}/${totalSwaps} completed`);
        } catch (err) {
          failedSwaps++;
          debugLog(`‚ùå Auto swap ${i}/${totalSwaps} failed: ${err.message}`);
        }
        
        // Wait before next swap (unless it's the last one or cancelled)
        if (i < totalSwaps && !autoSwapCancelled && waitTime > 0) {
          await countdown(waitTime);
        }
      }
      
      // Final summary
      const summary = `ü§ñ Auto swap finished: ${completedSwaps} completed, ${failedSwaps} failed`;
      debugLog(summary);
      document.getElementById("autoProgress").textContent = summary;
      
      stopAutoSwap();
    }

    function stopAutoSwap() {
      autoSwapRunning = false;
      autoSwapCancelled = true;
      
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      
      // Reset UI
      document.getElementById("autoStart").style.display = "block";
      document.getElementById("autoStop").style.display = "none";
      document.getElementById("autoPanel").classList.remove("active");
      document.getElementById("swap").disabled = false;
      document.getElementById("swapCount").disabled = false;
      document.getElementById("waitTime").disabled = false;
      document.getElementById("randomAmountToggle").disabled = false;
      document.getElementById("minAmount").disabled = false;
      document.getElementById("maxAmount").disabled = false;
      document.getElementById("autoCountdown").textContent = "";
      
      if (!autoSwapCancelled) {
        document.getElementById("autoProgress").textContent = "Ready";
      }
    }

    async function countdown(seconds) {
      return new Promise(resolve => {
        let remaining = seconds;
        document.getElementById("autoCountdown").textContent = `Next swap in ${remaining}s...`;
        
        countdownInterval = setInterval(() => {
          remaining--;
          if (remaining <= 0 || autoSwapCancelled) {
            clearInterval(countdownInterval);
            countdownInterval = null;
            document.getElementById("autoCountdown").textContent = "";
            resolve();
          } else {
            document.getElementById("autoCountdown").textContent = `Next swap in ${remaining}s...`;
          }
        }, 1000);
      });
    }

    // Event listeners
    document.getElementById("connect").onclick = connectWallet;
    document.getElementById("swap").onclick = swap;
    document.getElementById("autoStart").onclick = startAutoSwap;
    document.getElementById("autoStop").onclick = stopAutoSwap;
    
    document.getElementById("inputMint").onchange = () => {
      updateBalance();
      updateActiveVault();
      getEstimate();
    };
    document.getElementById("amount").oninput = getEstimate;
    document.getElementById("outputMint").onchange = getEstimate;

    // Initialize vault display
    updateActiveVault();
  </script>
</body>
</html>